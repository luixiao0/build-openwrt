#
#
# æ„Ÿè°¢p3terxå¤§ç¥çš„ä¸€é”®ç¼–è¯‘è„šæœ¬
# 
# Copyright (C) 2019 P3TERX <https://p3terx.com>
# <https://github.com/P3TERX/Actions-OpenWrt.git>
#


name: ç¼–è¯‘OpenWrtå›ºä»¶

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'Person to greet'
        required: true
        default: 'build-openwrt'


#ç¼–è¾‘ä»»æ„æŒ‡å®šæ–‡ä»¶è§¦å‘å¼€å§‹ç¼–è¯‘
#  push:
#    branches:
#      - master
#    paths:
#      - 'å¼€å¯ç¼–è¯‘openwrt'


#å®šæ—¶è§¦å‘å¼€å§‹ç¼–è¯‘(å¼€å¯å®šæ—¶ç¼–è¯‘è¯·å…ˆç¡®å®šSSHå¤„åœ¨å…³é—­çŠ¶æ€,è¦ä¸ç„¶SSHæ²¡äººç®¡,ä¼šå¡SSHç¼–è¯‘å¤±è´¥)
#  schedule:
#    - cron: 0 8 */5 * *


#ç‚¹â˜†Starè§¦å‘å¼€å§‹ç¼–è¯‘
  watch:
#    types: started


env:
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
  SCKEY: ${{ secrets.SCKEY }}
  GITHUB_RELEASE: https://github.com/281677160/Actions-OpenWrt/releases
  TZ: Asia/Shanghai

jobs: 
  build:
    runs-on: ubuntu-18.04
    if: github.event.repository.owner.id == github.event.sender.id

    name: ç¼–è¯‘ ${{matrix.target}}
    strategy:
      fail-fast: false
      matrix:
        target: [Project_x86_64]  #[Lede_x86_64,Lede_redmi_ac2100,Lede_newifi_d2,Lede_phicomm_k2p,Lienol_x86_64,Lienol_phicomm_k2p,Lienol_phicomm_k3,Project_x86_64,Project_newifi_d2,Project_phicomm_k3]

    steps:
    - name: å‡†å¤‡ç»“æŸ
      uses: actions/checkout@v2
 
    - name: æ£€æµ‹è„šæœ¬è®¾ç½®
      run: |
        source "${GITHUB_WORKSPACE}/build/${{matrix.target}}/settings.ini"
        echo "::set-env name=REPO_URL::${REPO_URL}"
        echo "::set-env name=REPO_BRANCH::${REPO_BRANCH}"
        echo "::set-env name=CONFIG_FILE::${CONFIG_FILE}"
        echo "::set-env name=WXFB_MESSAGE::${WXFB_MESSAGE}"
        echo "::set-env name=DIY_P1_SH::${DIY_P1_SH}"
        echo "::set-env name=DIY_P2_SH::${DIY_P2_SH}"
        echo "::set-env name=SSH_ACTIONS::${SSH_ACTIONS}"
        echo "::set-env name=UPLOAD_BIN_DIR::${UPLOAD_BIN_DIR}"
        echo "::set-env name=UPLOAD_CONFIG::${UPLOAD_CONFIG}"
        echo "::set-env name=UPLOAD_FIRMWARE::${UPLOAD_FIRMWARE}"
        echo "::set-env name=UPLOAD_COWTRANSFER::${UPLOAD_COWTRANSFER}"
        echo "::set-env name=UPLOAD_RELEASE::${UPLOAD_RELEASE}"
        echo "::set-env name=SERVERCHAN_SCKEY::${SERVERCHAN_SCKEY}"
    
    - name: å¾®ä¿¡é€šçŸ¥
      if: env.SERVERCHAN_SCKEY == 'true'
      uses: emon100/Action-Serverchan@master
      with:
        SCKEY: ${{ secrets.SCKEY }}
        text: å¼€å§‹ç¼–è¯‘${{matrix.target}}å•¦
        desp: ä¸»äººæ‚¨è®¾ç½®è¦ç¼–è¯‘çš„[${{ env.WXFB_MESSAGE }}]å›ºä»¶æ­£åœ¨åŠªåŠ›è€•è€˜ä¸­......
    
    - name: å¼€å§‹å®‰è£…ç¼–è¯‘æ‰€éœ€ç³»ç»Ÿ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-1804)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: ä¸‹è½½å›ºä»¶æºç 
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: åŠ è½½æº,patchè¡¥ä¸å’Œè‡ªå®šä¹‰è®¾ç½®
      run: |
        cp -Rf `find ./ -maxdepth 1 -type d ! -path './openwrt' ! -path './'` openwrt
        cd openwrt
        if [ -n "$(ls -A "build/${{matrix.target}}/patches" 2>/dev/null)" ]; then
        (
          find "build/${{matrix.target}}/patches" -type f -name '*.patch' -print0 | sort -z | xargs -I % -t -0 -n 1 sh -c "cat '%'  | patch -d './' -p0 --forward" || true
        )
        fi
        if [ -f "build/${{matrix.target}}/$DIY_P1_SH" ]; then
        (
          chmod +x build/${{matrix.target}}/$DIY_P1_SH
          /bin/bash "build/${{matrix.target}}/$DIY_P1_SH"
        )
        fi
        ./scripts/feeds clean
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        if [ -n "$(ls -A "build/${{matrix.target}}/files" 2>/dev/null)" ]; then
         cp -rf build/${{matrix.target}}/files files
        fi
        if [ -n "$(ls -A "build/${{matrix.target}}/diy" 2>/dev/null)" ]; then
         cp -Rf build/${{matrix.target}}/diy/* ./
        fi        
        if [ -f "build/${{matrix.target}}/$DIY_P2_SH" ]; then
        (
          chmod +x build/${{matrix.target}}/$DIY_P2_SH
          /bin/bash "build/${{matrix.target}}/$DIY_P2_SH"
        )
        fi
         mv build/${{matrix.target}}/$CONFIG_FILE .config
        make defconfig
        [ $(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/') == generic ] && DEVICE_NAME=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/CONFIG_TARGET_(.*)_DEVICE_.*=y/\1/') || DEVICE_NAME=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/')
        DEVICE_NAME=`echo ${DEVICE_NAME/xiaomi_redmi-router/redmi}`
        echo "::set-env name=DEVICE_NAME::$DEVICE_NAME"
    
    - name: SSHè¿œç¨‹è¿æ¥æœåŠ¡å™¨é…ç½®å›ºä»¶
      uses: P3TERX/debugger-action@main
      if: env.SSH_ACTIONS == 'true' || contains(github.event.action, 'ssh')

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      id: package
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "::set-output name=status::success"
        echo "::set-env name=date::$(date "+%Y-%m-%d %H.%M")"
        echo "::set-env name=date1::$(date +'%Yå¹´%mæœˆ%då·-%Hç‚¹%Måˆ†')"
        echo "::set-env name=date2::$(date +'%Y%m%d-%H%M')"
    
    - name: ä¸Šä¼ binæ–‡ä»¶å¤¹(å›ºä»¶+ipk)åœ¨githubç©ºé—´
      uses: actions/upload-artifact@v2
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin_${{matrix.target}}_${{ env.date }}
        path: openwrt/bin

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶å¤¹
      id: organizer
      run: |
        mkdir config
        find openwrt/bin/targets/ -name "*config.buildinfo*" | xargs -i mv -f {} config        
        cd openwrt/bin/targets/*/*
        rm -rf packages && mkdir packages
        find -name "*.buildinfo*" | xargs -i mv -f {} packages
        find -name "*sha256sums*" | xargs -i mv -f {} packages
        find -name "*kernel.bin*" | xargs -i mv -f {} packages
        find -name "*kernel1.bin*" | xargs -i mv -f {} packages
        find -name "*rootfs*" | xargs -i mv -f {} packages
        find -name "*.manifest*" | xargs -i mv -f {} packages
        find -name "*vmlinuz*" | xargs -i mv -f {} packages
        find -name "*esxi.vmdk*" | xargs -i mv -f {} packages
        rm -rf packages
        echo "::set-env name=FIRMWARE::$PWD"
        echo "::set-output name=status::success"
        
    - name: ä¸Šä¼ .configé…ç½®æ–‡ä»¶åœ¨githubç©ºé—´    
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_CONFIG == 'true'
      uses: actions/upload-artifact@v2
      with:
        name: .config_${{matrix.target}}_${{ env.date }}
        path: ./config

    - name: ä¸Šä¼ å›ºä»¶åœ¨githubç©ºé—´
      uses: actions/upload-artifact@v2
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
      with:
        name: OpenWrt_firmware_${{matrix.target}}_${{ env.date }}
        path: ${{ env.FIRMWARE }}

    - name: ä¸Šä¼ å›ºä»¶åˆ°ã€Œå¥¶ç‰›å¿«ä¼ ã€å’Œã€Œwetransferã€
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
        echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
        echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
    
    - name: æå–å‘å¸ƒç”¨çš„ã€Œå¥¶ç‰›å¿«ä¼ ã€è·Ÿã€ŒWeTransferã€çš„é“¾æ¥
      if: steps.organizer.outputs.status == 'success' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
        echo "::set-env name=COWTRANSFER_URL::$(cat cowtransfer.log | grep https | cut -f3 -d" ")" 
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
        echo "::set-env name=WETRANSFER_URL::$(cat wetransfer.log | grep https | cut -f3 -d" ")"    
    
    - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶
      uses: softprops/action-gh-release@v1
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
      with:
        name: ${{ env.date1 }} ã€Œ ${{ env.WXFB_MESSAGE }} ã€å›ºä»¶
        tag_name: ${{ env.date2 }}
        body: |            
            â˜†  æºç  : ${{ env.REPO_URL }}
            â˜†  åˆ†æ”¯ : ${{ env.REPO_BRANCH }}
            â˜†  æ„Ÿè°¢æºç ä½œè€…æ— ç§åˆ†äº«ï¼
            
            ğŸ‰ [ ${{matrix.target}} ]å›ºä»¶ä¸‹è½½ âœ¨
            
            ğŸ’ å¥¶ç‰›å¿«ä¼ (å›½å†…é«˜é€ŸğŸš€ä¸‹è½½)ï¼š ${{ env.COWTRANSFER_URL }}
            
            â›„ WeTransfer(å›½å¤–é«˜é€ŸğŸš€ä¸‹è½½)ï¼š ${{ env.WETRANSFER_URL }}
            
            ğŸŒ´ é“¾æ¥æœ‰æ•ˆæœŸä¸º7å¤©ï¼Œæ— éœ€æ³¨å†Œç›´æ¥ä¸‹è½½ ğŸ¤
        files: ${{ env.FIRMWARE }}/*

    - name: å¾®ä¿¡é€šçŸ¥
      if: steps.organizer.outputs.status == 'success' && env.SERVERCHAN_SCKEY == 'true'
      uses: emon100/Action-Serverchan@master
      with:
        SCKEY: ${{ secrets.SCKEY }}
        text: æ­å–œä¸»äºº${{matrix.target}}å›ºä»¶ç¼–è¯‘æˆåŠŸï¼
        desp: æˆ‘äº²çˆ±çš„ä¸»äººæ‚¨è¦ç¼–è¯‘çš„${{ env.WXFB_MESSAGE }}å›ºä»¶æˆåŠŸå®Œæˆäº†ï¼
              
              
              å®Œæˆæ—¶é—´ï¼š${{ env.date1 }}
              
              
              å‘å¸ƒåœ°å€ï¼š${{ env.GITHUB_RELEASE }}
              
              
              å¥¶ç‰›å¿«ä¼ ï¼š${{ env.COWTRANSFER_URL }}
              
              
              WeTransferï¼š${{ env.WETRANSFER_URL }}
              
              
              ç¥å°ä¸»äººè§äººçˆ±ï¼ŒèŠ±è§èŠ±å¼€ï¼Œè½¦è§è½¦è½½ï¼Œå¤©å¤©å¥½å¿ƒæƒ…ğŸˆï¼ï¼ï¼
